# 战斗数据计算
## 计算前置准备 - 参数参考
### 有效技能等级 ESL
* `有效技能等级 = 技能等级 + 隐藏技能等级`

若无特殊情况，均以有效技能等级进行计算。

> 只有近战有“隐藏力量等级”

### 装备加成 EA/ED
装备加成指的是装备提供的“xx加成”属性。它可以在战斗界面点击“查看装备属性”弹出的窗口中看到。在仓库点击装备，在右侧弹出的框中点“查看物品属性”也可以看到。

“进攻属性 EA”栏包括
+ 近战技能
    - 攻击加成：分为戳刺/劈砍/格挡加成
    - 力量加成
+ 远程技能
    - 攻击加成
    - 力量加成
+ 魔法技能
    - 攻击加成
    - *伤害加成*(MDB)

“防御属性 ED”栏包括
* 近战防御
* 远程防御
* 魔法防御
* *伤害减免*(DR)

只有近战技能的攻击加成会与具体选择的战斗风格有关。

除上述已有缩写外，一般一次计算最多会涉及这之中的三个属性，即攻击加成、力量加成、防御加成，分别用 BA、BS、BD 表示。

#### 伤害减免计算
伤害减免超出 95% 以 95% 计。

#### 敌人伤害减免规律
伤害减免从战斗等级 100 开始(5%)，每 100 级增加 5%，上限 25%。

### 百分比修正值 CC
维基在百分比计算上，采用的是`百分值/100`的形式，比如我有一个 60% 的加成(bonus)，它在算式中会显示为 `60/100`。

在这里 60% 就是 0.6，不会像维基那样有为照顾大范围用户而进行的设计。

### 外部线性加成 CL
外部线性加成是将直接加到最终结果上。
> 例1：有 60% 的命中率和 10% 的 CL，最终的命中率为 70%。
> 例2：有 60 伤害和 10 的 CL，最终伤害为 70

### 伤害计算后修正值 PRM
这部分内容有敌人 DR 和祝祭加成等。

## 命中率计算 CtH
* `精准 AR = 向下取整[(ESL +9) x (B +64)] x (1+ CC)]`
* `躲避 ER = 向下取整[(ESL +9) x (ED +64) x (1+ CC)]`
* 魔法在计算躲避时候，ESL 的计算方法为
    + `ESL = 有效防御等级 x0.3 + 有效魔法等级 x0.7`
以攻击者的 AR 对抗被攻击者的 ER：
* AR \< ER
    + `CtH = AR / (2x ER)`
* AR \> ER
    + `CtH = 1 - [ER / (2x AR)]`
* AR = ER： 50%

## 伤害计算
### 最大伤害
* 近战 & 远程基础最大伤害 BMD
    + `BMD = 向下取整[2.2+ ESL /10 + (ESL+17) x EA /640] /100`
* 魔法基础最大伤害 BMD
    + 咒语伤害 SD
    + `BMD = 向下取整[SD x (1+ MDB) x (1+ CC)]`
* 最大伤害 MD
    + `MD = 向下取整[BMD x (1+ CC)] + CL`

### 伤害期望 DPH、DPS
* 攻击间隔 AT 以秒为单位，如 3.2s 计为 3.2
* `单次命中伤害期望 DPH = (最大伤害 + 最小伤害) x (1- 伤害减免) /2`
* `每秒伤害期望 DPS = DPH x CtH / AT`

最大伤害如上，最小伤害受```最大伤害转化为最小伤害`和线性最小伤害加成影响。

*P.S：+10% 最大伤害转化为最小伤害是翻译错误，实则是将最大伤害的 10% 加到最小伤害上。*

### 暴击
玩家的基础暴击率为 0%，当发生暴击时，伤害 +50%。

## 特殊攻击几率
默认情况下，玩家是 100% 普通攻击。当玩家拥有特殊攻击时，先会用特殊攻击几率替换普通攻击的几率。而出现多个特殊攻击并使总特殊攻击几率达到或超过 100% 时，将使用权重算法分配各特殊攻击的实际触发几率。

> 例：现有 15% 触发的特殊攻击A，100% 触发的特殊攻击B。若只装备带有特殊攻击A 的装备，那么特殊攻击A 触发的几率为 15%。若 A&B 同时存在，那么 A 的触发几率会变为 15 / (100+15) = 13.904%，B 的触发几率则为 86.96%。

## 召唤攻击
战斗类使魔在战斗中也会一起攻击敌人，它们的攻击间隔固定为3s，并会在你的角色无法行动时也停止攻击。

使魔提供的是“召唤最大伤害”，“最小伤害”固定为 1。在攻击时，两个使魔的最大伤害相加作为实际的最大伤害。

使魔只在召唤攻击时消耗。

召唤最大伤害：
* 哥布林小偷：21
* 邪教徒：40
* 狼：59
* 牛头人：78
* 半人马：97
* 女巫：116
* 独眼巨人：135
* 牦牛：154
* 独角兽：173
* 龙：192
* 雷霆之魂：202
* 海妖：207
* 蜘蛛：212
* 幽灵：217

## 常用战斗计算方法
### 是否可以挂机 - Can I Idle
计算是否可以挂机，需要计算的是**自动进食阈值**、伤害减免、最大生命值和敌人最大攻击。

当`敌人最大攻击 x (1- 我方伤害减免) < 我方最大生命值 x 自动进食阈值`，并且食物充足时，就可以放心挂机了。

这里要注意：
1. 在战斗中，敌人面板显示的最大伤害已经计算了你的伤害减免
2. 如果想以一套配置挂机副本，则需要考虑副本中所有敌人中的最大攻击，这可能涉及所有战斗三角的计算